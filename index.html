<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step Counter App</title>
    <link rel="manifest" href="/step-counter-pwa/manifest.json" /> 
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="/icon-192.png" /> 

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },

                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#6366f1',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom styles for better mobile appeal */
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }

        .counter-display {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            width: 200px;
            margin: 0 auto;
            border-radius: 9999px; /* Full circle */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-image: linear-gradient(135deg, #a78bfa 0%, #4f46e5 100%);
            color: white;
            transition: transform 0.3s ease-in-out;
        }

        .counter-display.running {
            box-shadow: 0 0 0 10px rgba(79, 70, 229, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        .main-button {
            transition: all 0.15s ease-in-out;
        }

        .main-button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="p-4 flex flex-col min-h-screen">
    <div class="max-w-md w-full mx-auto">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8 mt-4">üèÉ Step Tracker</h1>
        <div id="counterDisplay" class="counter-display mb-10 running">
            <span id="steps" class="text-7xl font-bold">0</span>
        </div>

        <div class="text-center mb-6 h-12">
            <p id="statusMessage" class="text-sm font-medium text-gray-600">Press 'Start' to begin tracking.</p>
        </div>

        <div class="flex space-x-4">
            <button id="startButton" onclick="requestSensorAccess()"
                    class="main-button w-full px-6 py-4 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-secondary focus:outline-none focus:ring-4 focus:ring-primary/50 transition-colors duration-150">
                Start Tracking
            </button>

            <button id="resetButton" onclick="resetCounter()"
                    class="main-button px-6 py-4 bg-gray-300 text-gray-800 text-lg font-semibold rounded-xl shadow-lg hover:bg-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-300/50 transition-colors duration-150">
                Reset
            </button>
        </div>

        <div id="warningBox" class="mt-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg hidden">
            <p class="font-bold">Permissions Required</p>
            <p class="text-sm">Please allow motion sensor access when prompted to enable step counting.</p>
        </div>

        <div id="notSupportedBox" class="mt-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg hidden">
            <p class="font-bold">Feature Not Supported</p>
            <p class="text-sm">Device motion sensors are not supported on this browser or device.</p>
        </div>
    </div>

    <script>
        // --- Core JavaScript Logic ---
        // Sensor Constants
        const ACCELERATION_THRESHOLD = 0.5; // Threshold for Z-axis acceleration to register a step
        const STEP_DEBOUNCE_TIME = 200;    // Milliseconds to wait before registering another step

        // DOM Elements
        const stepsElement = document.getElementById('steps');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const statusMessage = document.getElementById('statusMessage');
        const counterDisplay = document.getElementById('counterDisplay');
        const warningBox = document.getElementById('warningBox');
        const notSupportedBox = document.getElementById('notSupportedBox');

        // State Variables
        let stepCount = 0;
        let isRunning = false;
        let lastStepTime = 0;
        let lastZ = 0;

        /**
         * Checks browser support and handles iOS/Safari permission request on click.
         */

        async function requestSensorAccess() {
            if (isRunning) {
                // If already running, treat the button click as a stop command
                toggleCounting();
                return;
            }

            // Check if DeviceMotion is supported
            if (!('DeviceMotionEvent' in window)) {
                notSupportedBox.classList.remove('hidden');
                statusMessage.textContent = "Motion sensor not supported.";
                return;
            }

            // iOS 13+ requires explicit permission request
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                warningBox.classList.remove('hidden');
                try {
                    const permissionState = await DeviceMotionEvent.requestPermission();
                    warningBox.classList.add('hidden');
                    if (permissionState === 'granted') {
                        toggleCounting(true);
                    } else {
                        statusMessage.textContent = "Permission denied. Cannot track steps.";
                        startButton.textContent = "Permission Denied";
                        startButton.disabled = true;
                    }
                } catch (error) {
                    console.error("Error requesting motion permission:", error);
                    statusMessage.textContent = "Error requesting motion permission.";
                }
            } else {
                // For Android and other browsers that don't need a formal request
                toggleCounting(true);
            }
        }

        /**
         * The core logic for detecting steps based on device acceleration.
         * We look for significant changes in the Z-axis (up/down movement).
         * @param {DeviceMotionEvent} event
         */

        function handleDeviceMotion(event) {
            if (!isRunning) return;
            // Use accelerationIncludingGravity for robust detection
            const currentZ = event.accelerationIncludingGravity.z;
            const timeNow = Date.now();
            // Calculate the change in acceleration
            const deltaZ = currentZ - lastZ;
            // Check for a sharp acceleration change (a 'step')
            // And ensure the step is sufficiently spaced in time (debounce)
            if (Math.abs(deltaZ) > ACCELERATION_THRESHOLD && (timeNow - lastStepTime) > STEP_DEBOUNCE_TIME) {
                // Simple peak detection: We just need to register a significant change.
                stepCount++;
                stepsElement.textContent = stepCount;
                lastStepTime = timeNow;
            }

            // Update the last Z value for the next calculation
            lastZ = currentZ;
        }

        /**
         * Starts or stops the step counting process.
         * @param {boolean} forceStart Optional: if true, forces the start state.
         */

        function toggleCounting(forceStart = null) {
            const shouldRun = forceStart !== null ? forceStart : !isRunning;
            if (shouldRun) {
                // Start Tracking
                window.addEventListener('devicemotion', handleDeviceMotion);
                startButton.textContent = "Stop Tracking";
                startButton.classList.remove('bg-primary');
                startButton.classList.add('bg-red-500', 'hover:bg-red-600');
                statusMessage.textContent = "Tracking active. Start walking!";
                counterDisplay.classList.add('running');
                isRunning = true;
            } else {
                // Stop Tracking
                window.removeEventListener('devicemotion', handleDeviceMotion);
                startButton.textContent = "Start Tracking";
                startButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                startButton.classList.add('bg-primary', 'hover:bg-secondary');
                statusMessage.textContent = `Tracking paused. Total steps: ${stepCount}.`;
                counterDisplay.classList.remove('running');
                isRunning = false;
            }
        }

        /**
         * Resets the step counter and display.
         */

        function resetCounter() {
            if (isRunning) {
                toggleCounting(false); // Stop tracking first
            }
            stepCount = 0;
            lastStepTime = 0;
            stepsElement.textContent = 0;
            statusMessage.textContent = "Counter reset. Press 'Start' to begin tracking.";
            console.log("Step counter reset.");
        }

        // Add a global error handler for unsupported features if necessary

        window.addEventListener('error', (e) => {
            console.error("An error occurred:", e.message);
        });

        // --- PWA Service Worker Registration - ADDED CODE HERE
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Register the service worker immediately for best performance.
                navigator.serviceWorker.register('/step-counter-pwa/sw.js', { scope: '/step-counter-pwa/' })
                .then(reg => {
                    console.log('Service Worker registered! Scope:', reg.scope);
                })
                .catch(err => {
                    console.warn('Service Worker registration failed:', err);
                });
            }
        }

        registerServiceWorker();
        // --- Existing boilerplate variables below ---
        var appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        var firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        var __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>
</body>
</html>
